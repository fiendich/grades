{% extends "base.html" %}
{% block title %}Noten{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
#noten-header { text-align: center; margin-bottom: 2rem; }
#subject-tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid #1976d2; margin-bottom: 1.5rem; overflow-x: auto; }
#subject-tabs .tab { color: #1976d2; background: #f8f9fa; padding: 0.8rem 2rem; font-size: 1.1rem; border: none; border-radius: 0.5rem 0.5rem 0 0; margin-right: 0.2rem; cursor: pointer; transition: background 0.2s, color 0.2s; }
#subject-tabs .tab.active { background: #fff; color: #1976d2; border-bottom: 2px solid #fff; font-weight: bold; border-bottom: 3px solid #1976d2; }
.grade-table th, .grade-table td { text-align: center; vertical-align: middle; font-size: 1.05rem; }
.grade-table th { background: #f8f9fa; }
.grade-table .note-green { background: #e6f4ea; color: #218838; font-weight: bold; }
.grade-table .note-yellow { background: #fffbe6; color: #b8860b; font-weight: bold; }
.grade-table .note-red { background: #f8d7da; color: #721c24; font-weight: bold; }
.grade-table .action-icons { opacity: 0; transition: opacity 0.2s; display: flex; justify-content: center; align-items: center; }
.grade-table tr:hover .action-icons { opacity: 1; }
.grade-table tr:hover { background: #f2f2f2; }
.grade-table .influence { font-size: 0.95rem; }
  .schueler-info-card {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    border-radius: 1.5rem;
    padding: 1.1rem 2.2rem;
    font-size: 1.25rem;
    font-weight: 500;
    margin-bottom: 1.5rem;
  }
  .schueler-info-card i {
    color: #1976d2;
    font-size: 1.7rem;
  }
  .schueler-info-card .schueler-name {
    font-weight: bold;
    font-size: 1.3rem;
  }
  .schueler-info-card .schueler-class {
    color: #555;
    font-size: 1.1rem;
  }
  .schueler-info-card .schuljahr {
    color: #888;
    font-size: 1.05rem;
    margin-left: 0.7rem;
  }
.grade-value-select {
  min-width: 70px;
  font-size: 1.1rem;
  font-weight: bold;
  text-align: center;
}
.grade-value-select option {
  text-align: center;
}
@media print {
  .no-print { display: none !important; }
  .table-print-narrow { width: 80% !important; margin: 0 auto !important; }
}
</style>
<div id="noten-header">
  <div class="schueler-info-card">
    <span class="schueler-name">{{ selected_student.first_name }} {{ selected_student.last_name }}</span>
    <span class="schueler-class">{{ selected_student.class_.name }}</span>
    <span class="schuljahr">2024/25</span>
  </div>
</div>
<div id="subject-tabs">
  <button class="tab{% if selected_subject_id is none or selected_subject_id == 0 %} active{% endif %}" data-subject-id="0">Allgemein</button>
  {% for subject in subjects %}
    <button class="tab{% if selected_subject_id is not none and subject.id == selected_subject_id %} active{% endif %}" data-subject-id="{{ subject.id }}">{{ subject.name }}</button>
  {% endfor %}
</div>
<!-- Übersichtspanel für Allgemein -->
{% if selected_subject_id is none or selected_subject_id == 0 %}
<div class="subject-panel" id="subject-panel-0" style="display: block;">
  <div class="table-responsive mb-4">
    <table class="table table-bordered table-sm table-print-narrow" style="background:#fff; margin:0 auto; width:100%;">
      <thead style="background:#fff;">
        <tr>
          <th style="width:39.7%; background:#fff; text-align:left;">Fach</th>
          <th style="width:10.6%; background:#fff; text-align:left;">2x</th>
          <th style="width:32.3%; background:#fff; text-align:left;">1x</th>
          <th style="width:8.5%; background:#fff; text-align:left;">&#8709;</th>
          <th style="width:9%; background:#fff; text-align:left;">Note</th>
        </tr>
      </thead>
      <tbody>
        {% for row in overview_data %}
        <tr style="background:#fff;">
          <td style="background:#fff; text-align:left;">{{ row.subject }}</td>
          <td style="background:#fff; text-align:left;">{{ row.schulaufgaben }}</td>
          <td style="background:#fff; text-align:left;">{{ row.ex_kurz }}</td>
          <td style="background:#fff; text-align:left;">{% if row.avg != '-' %}{{ row.avg }}{% else %}-{% endif %}</td>
          <td style="background:#fff; text-align:left;">{% if row.abschluss != '-' %}{{ row.abschluss }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button class="btn btn-primary no-print" onclick="printTable()" style="margin-top:1rem;">Drucken</button>
  </div>
</div>
{% endif %}
<!-- Einzelne Fächer als eigene Panels -->
{% for subject in subjects %}
<div class="subject-panel" id="subject-panel-{{ subject.id }}" style="display: {% if selected_subject_id is not none and subject.id == selected_subject_id %}block{% else %}none{% endif %};">
  <table class="table grade-table mb-0">
    <thead>
      <tr>
        <th style="background:#f8f9fa; text-align:center;">Datum</th>
        <th style="background:#f8f9fa; text-align:center;">Note</th>
        <th style="background:#f8f9fa; text-align:center;">Art</th>
        <th style="background:#f8f9fa; text-align:center;">Gewichtung</th>
        <th style="background:#f8f9fa; text-align:center;">Kommentar</th>
        <th style="background:#f8f9fa; text-align:center;">Eingetragen von</th>
        <th style="background:#f8f9fa; text-align:center;">Eingetragen am</th>
        <th style="background:#f8f9fa; text-align:center;">Aktionen</th>
      </tr>
    </thead>
    <tbody>
      {% set subject_grades = [] %}
      {% for grade in grades if grade.subject_id == subject.id %}
        {% set _ = subject_grades.append(grade) %}
        <tr>
          <td style="background:#fff; text-align:center;">{{ grade.date.strftime('%d.%m.%Y') if grade.date else '' }}</td>
          <td style="background:#fff; text-align:center;" class="{% if grade.decrypted_value <= 2 %}note-green{% elif grade.decrypted_value <= 4 %}note-yellow{% else %}note-red{% endif %}">{{ grade.decrypted_value }}</td>
          <td style="background:#fff; text-align:center;">{{ grade.note_type }}</td>
          <td style="background:#fff; text-align:center;">{{ grade.weight|round(1) }}x</td>
          <td style="background:#fff; text-align:center;">{{ grade.kommentar or '' }}</td>
          <td style="background:#fff; text-align:center;">{% set lehrer = users | selectattr('id', 'equalto', grade.created_by) | first %}{{ lehrer.kuerzel if lehrer else '-' }}</td>
          <td style="background:#fff; text-align:center;">{% if grade.created_at %}{{ grade.created_at.strftime('%d.%m.%Y %H:%M') }}{% else %}-{% endif %}</td>
          <td style="background:#fff; text-align:left;">
            <span class="action-icons">
              <a href="#" onclick="editNote({{ grade.id }}, {{ subject.id }})" title="Bearbeiten"><i class="fa fa-pen"></i></a>
              <form method="POST" action="/grades/delete/{{ grade.id }}" style="display:inline;">
                <button type="submit" class="btn btn-link p-0" title="Löschen"><i class="fa fa-trash"></i></button>
              </form>
            </span>
          </td>
        </tr>
      {% endfor %}
      {% if not subject_grades %}
        <tr><td colspan="8" class="text-center" style="background:#fff;">Keine Noten vorhanden</td></tr>
      {% endif %}
      <!-- Inline Add Row -->
      <tr id="add-row-{{ subject.id }}" style="display:none; background:#fff;">
        <form method="POST" action="/grades/add">
          <td style="background:#fff; text-align:left;"><input type="text" name="date" class="form-control" value="{{ today }}" required></td>
          <td style="background:#fff; text-align:center;">
            <select name="value" class="form-control grade-value-select" required>
              {% for n in range(1,7) %}
                <option value="{{ n }}">{{ n }}</option>
              {% endfor %}
            </select>
          </td>
          <td style="background:#fff; text-align:left;">
            <select name="note_type" class="form-control" onchange="setWeightByTypeInline(this, '{{ subject.id }}')" required>
              <option value="Schulaufgabe">Schulaufgabe</option>
              <option value="Kurzarbeit">Kurzarbeit</option>
              <option value="Ex">Ex</option>
            </select>
          </td>
          <td style="background:#fff; text-align:center;"><input type="number" name="weight" id="weight-input-{{ subject.id }}" step="0.1" class="form-control" value="2.0" required></td>
          <td style="background:#fff; text-align:left;"><input type="text" name="kommentar" class="form-control"></td>
          <td style="background:#fff; text-align:left;"></td>
          <td style="background:#fff; text-align:left;"></td>
          <td style="background:#fff; text-align:center;">
            <input type="hidden" name="student_id" value="{{ selected_student.id }}">
            <input type="hidden" name="subject_id" value="{{ subject.id }}">
            <button type="submit" class="btn btn-success btn-sm"><i class="fa fa-check"></i></button>
            <button type="button" class="btn btn-secondary btn-sm" onclick="hideAddRow('{{ subject.id }}')"><i class="fa fa-times"></i></button>
          </td>
        </form>
      </tr>
    </tbody>
    <tfoot>
      <tr>
        <td colspan="8" class="text-center">
          <button type="button" class="btn btn-link" onclick="showAddRow('{{ subject.id }}')"><i class="fa fa-plus"></i> Note einfügen</button>
        </td>
      </tr>
      <tr style="font-weight:bold; font-size:1.1rem;">
        <td>Ø</td>
        <td>
          {% set ns = namespace(fach_total=0, fach_weight_sum=0) %}
          {% for grade in subject_grades %}
            {% set ns.fach_total = ns.fach_total + (grade.decrypted_value * grade.weight) %}
            {% set ns.fach_weight_sum = ns.fach_weight_sum + grade.weight %}
          {% endfor %}
          {% set avg_fach = (ns.fach_total / ns.fach_weight_sum) if ns.fach_weight_sum > 0 else None %}
          {% if avg_fach is not none %}{{ avg_fach|round(2) }}{% else %}-{% endif %}
        </td>
        <td colspan="6"></td>
      </tr>
    </tfoot>
  </table>
</div>
{% endfor %}
<script>
const tabs = document.querySelectorAll('#subject-tabs .tab');
const panels = document.querySelectorAll('.subject-panel');
const selectedSubjectId = {{ selected_subject_id if selected_subject_id is not none else '0' }};
if (selectedSubjectId) {
  tabs.forEach((tab, idx) => {
    if (parseInt(tab.getAttribute('data-subject-id')) === selectedSubjectId) {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.style.display = 'none');
      tab.classList.add('active');
      if (selectedSubjectId !== 0 && panels[idx - 1]) {
        panels[idx - 1].style.display = 'block';
      }
    }
  });
}
tabs.forEach((tab, idx) => {
  tab.addEventListener('click', function() {
    tabs.forEach(t => t.classList.remove('active'));
    panels.forEach(p => p.style.display = 'none');
    tab.classList.add('active');
    const subjectId = parseInt(tab.getAttribute('data-subject-id'));
    if (subjectId === 0) {
      window.location.search = window.location.search.replace(/([&?])subject_id=\d+(&|$)/, '$1').replace(/([&?])subject_id=(&|$)/, '$1').replace(/([&?])$/, '');
    } else {
      const url = new URL(window.location.href);
      url.searchParams.set('subject_id', subjectId);
      window.location.href = url.toString();
    }
  });
});
function openNoteModal() {
  document.getElementById('note-modal').style.display = 'flex';
  const activeTab = document.querySelector('#subject-tabs .tab.active');
  if (activeTab) {
    document.getElementById('modal-subject').value = activeTab.getAttribute('data-subject-id');
  }
}
function closeNoteModal() {
  document.getElementById('note-modal').style.display = 'none';
}
function setWeightByType() {
  const type = document.getElementById('modal-note-type').value;
  let weight = 1.0;
  if (type === 'Schulaufgabe') weight = 2.0;
  else if (type === 'Kurzarbeit' || type === 'Mündlich') weight = 1.0;
  else if (type === 'Ex') weight = 1.0;
  document.getElementById('modal-weight').value = weight;
}
function editNote(gradeId, subjectId) {
  openNoteModal();
  document.getElementById('modal-subject').value = subjectId;
}
function showAddRow(subjectId) {
  document.getElementById('add-row-' + subjectId).style.display = '';
}
function hideAddRow(subjectId) {
  document.getElementById('add-row-' + subjectId).style.display = 'none';
}
function setWeightByTypeInline(select, subjectId) {
  let weightInput = document.getElementById('weight-input-' + subjectId);
  let type = select.value;
  if (type === 'Schulaufgabe') weightInput.value = 2.0;
  else if (type === 'Kurzarbeit') weightInput.value = 1.0;
  else if (type === 'Ex') weightInput.value = 1.0;
}

function printTable() {
  // Finde das aktuell sichtbare Panel
  const activePanel = Array.from(document.querySelectorAll('.subject-panel')).find(p => p.style.display === 'block');
  if (!activePanel) return;
  // Hole Header, aber entferne schueler-info-card für Druck
  const header = document.getElementById('noten-header');
  let headerHtml = '';
  if (header) {
    // Klone header und entferne schueler-info-card
    const headerClone = header.cloneNode(true);
    const infoCard = headerClone.querySelector('.schueler-info-card');
    if (infoCard) infoCard.remove();
    headerHtml = headerClone.innerHTML.trim() ? headerClone.outerHTML : '';
  }
  const styles = Array.from(document.querySelectorAll('style, link[rel="stylesheet"]'))
    .map(el => el.outerHTML).join('\n');
  // Panel-Klon für Manipulation
  const panelClone = activePanel.cloneNode(true);
  // Falls Allgemein-Panel: Passe Tabellenbreite an
  if (panelClone.id === 'subject-panel-0') {
    const table = panelClone.querySelector('table');
    if (table) {
      table.style.width = '80%';
      table.style.margin = '0 auto';
    }
  }
  // Neues Fenster mit Styles, Header (ohne schueler-info-card) und Panel
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
      <head>
        <title>Druckansicht</title>
        ${styles}
      </head>
      <body style=\"background:#fff; padding:32px;\">
        ${headerHtml}
        ${panelClone.outerHTML}
      </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => printWindow.print(), 200);
}

</script>
{% endblock %}

